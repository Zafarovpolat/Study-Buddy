import google.generativeai as genai
from typing import Dict, List, Any, Optional
import json
import asyncio
from functools import partial

from app.core.config import settings

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Gemini
genai.configure(api_key=settings.GEMINI_API_KEY)

class GeminiService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Gemini AI"""
    
    def __init__(self):
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–∏, –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞—è, —á—Ç–æ settings.GEMINI_MODEL –∑–∞–¥–∞–Ω
        self.model = genai.GenerativeModel(settings.GEMINI_MODEL)
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        self.generation_config = genai.types.GenerationConfig(
            temperature=0.7,
            top_p=0.9,
            max_output_tokens=4096,
        )
    
    async def _generate(self, prompt: str) -> str:
        """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ SDK –≤ executor."""
        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ü–∏–∫–ª —Å–æ–±—ã—Ç–∏–π (event loop)
        loop = asyncio.get_event_loop()
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –æ–ø–µ—Ä–∞—Ü–∏—é –≤ –ø—É–ª–µ –ø–æ—Ç–æ–∫–æ–≤ (None)
        response = await loop.run_in_executor(
            None,
            partial(
                self.model.generate_content,
                prompt,
                generation_config=self.generation_config
            )
        )
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç
        if not response.text:
             # –≠—Ç–æ –º–æ–∂–µ—Ç —Å–ª—É—á–∏—Ç—å—Å—è –∏–∑-–∑–∞ blocked prompt –∏–ª–∏ –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–±–ª–µ–º
             return "–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: –û—Ç–≤–µ—Ç –ø—É—Å—Ç."
             
        return response.text
    
    async def generate_smart_notes(self, content: str, title: str = "") -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–º–Ω—ã—Ö –∫–æ–Ω—Å–ø–µ–∫—Ç–æ–≤"""
        prompt = f"""–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é —É—á–µ–±–Ω—ã—Ö –∫–æ–Ω—Å–ø–µ–∫—Ç–æ–≤. 
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –º–∞—Ç–µ—Ä–∏–∞–ª –∏ —Å–æ–∑–¥–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Å–ø–µ–∫—Ç.

–ú–ê–¢–ï–†–ò–ê–õ:
{title}
{content[:settings.MAX_CONTENT_LENGTH]}

–ò–ù–°–¢–†–£–ö–¶–ò–ò:
1. –í—ã–¥–µ–ª–∏ 5-7 –∫–ª—é—á–µ–≤—ã—Ö —Ä–∞–∑–¥–µ–ª–æ–≤
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞:
   - –ó–∞–≥–æ–ª–æ–≤–æ–∫ (## –ù–∞–∑–≤–∞–Ω–∏–µ)
   - 3-5 –∫–ª—é—á–µ–≤—ã—Ö –ø—É–Ω–∫—Ç–æ–≤
   - –í–∞–∂–Ω—ã–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤ **–∂–∏—Ä–Ω–æ–º**
   - –ü—Ä–∏–º–µ—Ä—ã –≥–¥–µ —É–º–µ—Å—Ç–Ω–æ
3. –í –∫–æ–Ω—Ü–µ –¥–æ–±–∞–≤—å —Ä–∞–∑–¥–µ–ª "üéØ –ì–ª–∞–≤–Ω–æ–µ" —Å 3-5 –ø—É–Ω–∫—Ç–∞–º–∏

–§–æ—Ä–º–∞—Ç: Markdown
–Ø–∑—ã–∫: —Ç–æ—Ç –∂–µ, —á—Ç–æ –≤ –º–∞—Ç–µ—Ä–∏–∞–ª–µ (—Ä—É—Å—Å–∫–∏–π/–∞–Ω–≥–ª–∏–π—Å–∫–∏–π)
"""
        return await self._generate(prompt)
    
    async def generate_tldr(self, content: str) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫—Ä–∞—Ç–∫–æ–≥–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è"""
        prompt = f"""–°–æ–∑–¥–∞–π –∫—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ (TL;DR) –¥–ª—è —ç—Ç–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞.

–ú–ê–¢–ï–†–ò–ê–õ:
{content[:settings.MAX_CONTENT_LENGTH]}

–ò–ù–°–¢–†–£–ö–¶–ò–ò:
1. –ú–∞–∫—Å–∏–º—É–º 5-7 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
2. –¢–æ–ª—å–∫–æ —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ
3. –ù–∞—á–Ω–∏ —Å "üìå **–°—É—Ç—å:**"
4. –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Å—Ç–æ–π —è–∑—ã–∫

–§–æ—Ä–º–∞—Ç: –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç —Å —ç–º–æ–¥–∑–∏
"""
        return await self._generate(prompt)
    
    async def generate_quiz(self, content: str, num_questions: int = 5) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–∞ —Å –ø–æ–ø—ã—Ç–∫–æ–π –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON"""
        prompt = f"""–°–æ–∑–¥–∞–π —Ç–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–Ω–∏–º–∞–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞.

–ú–ê–¢–ï–†–ò–ê–õ:
{content[:settings.MAX_CONTENT_LENGTH]}

–ò–ù–°–¢–†–£–ö–¶–ò–ò:
1. –°–æ–∑–¥–∞–π —Ä–æ–≤–Ω–æ {num_questions} –≤–æ–ø—Ä–æ—Å–æ–≤
2. –ö–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å —Å 4 –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –æ—Ç–≤–µ—Ç–∞ (A, B, C, D)
3. –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
4. –í–æ–ø—Ä–æ—Å—ã —Ä–∞–∑–Ω–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏

–§–û–†–ú–ê–¢ (—Å—Ç—Ä–æ–≥–æ JSON):
```json
{{
  "questions": [
    {{
      "id": 1,
      "question": "–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞?",
      "options": {{
        "A": "–í–∞—Ä–∏–∞–Ω—Ç –ê",
        "B": "–í–∞—Ä–∏–∞–Ω—Ç –ë",
        "C": "–í–∞—Ä–∏–∞–Ω—Ç –í",
        "D": "–í–∞—Ä–∏–∞–Ω—Ç –ì"
      }},
      "correct": "A",
      "explanation": "–ö—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç"
    }}
  ]
}}
–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.
"""
        # –í–µ—Å—å –∫–æ–¥ –Ω–∏–∂–µ –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –æ—Ç—Å—Ç—É–ø 4 –ø—Ä–æ–±–µ–ª–∞, —á—Ç–æ–±—ã –±—ã—Ç—å –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏
        response = await self._generate(prompt)
        
        # –ü—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å –∏ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å JSON
        try:
            json_str = response
            
            # –£–±–∏—Ä–∞–µ–º markdown –±–ª–æ–∫–∏, –µ—Å–ª–∏ –µ—Å—Ç—å
            if "```json" in json_str:
                # –ë–µ—Ä–µ–º –≤—Å–µ, —á—Ç–æ –º–µ–∂–¥—É –ø–µ—Ä–≤—ã–º '```json' –∏ —Å–ª–µ–¥—É—é—â–∏–º '```'
                json_str = json_str.split("```json", 1)[1].split("```", 1)[0]
            elif "```" in json_str:
                # –ë–µ—Ä–µ–º –≤—Å–µ, —á—Ç–æ –º–µ–∂–¥—É –ø–µ—Ä–≤—ã–º '```' –∏ —Å–ª–µ–¥—É—é—â–∏–º '```' (–º–µ–Ω–µ–µ –Ω–∞–¥–µ–∂–Ω–æ)
                json_str = json_str.split("```", 1)[1].split("```", 1)[0]
            
            # –í–∞–ª–∏–¥–∏—Ä—É–µ–º JSON
            parsed = json.loads(json_str.strip())
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, —á–∏—Ç–∞–±–µ–ª—å–Ω—ã–π JSON
            return json.dumps(parsed, ensure_ascii=False, indent=2)
        except json.JSONDecodeError:
            # –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—ã—Ä–æ–π –æ—Ç–≤–µ—Ç
            print(f"JSON Decode Error in generate_quiz. Raw response: {response[:200]}...")
            return response

    async def generate_glossary(self, content: str) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≥–ª–æ—Å—Å–∞—Ä–∏—è —Ç–µ—Ä–º–∏–Ω–æ–≤"""
        prompt = f"""–°–æ–∑–¥–∞–π –≥–ª–æ—Å—Å–∞—Ä–∏–π –∫–ª—é—á–µ–≤—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤ –∏–∑ –º–∞—Ç–µ—Ä–∏–∞–ª–∞.
–ú–ê–¢–ï–†–ò–ê–õ:
{content[:settings.MAX_CONTENT_LENGTH]}

–ò–ù–°–¢–†–£–ö–¶–ò–ò:

–í—ã–¥–µ–ª–∏ 10-15 –∫–ª—é—á–µ–≤—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤
–î–∞–π –∫—Ä–∞—Ç–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞–∂–¥–æ–º—É (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
–û—Ç—Å–æ—Ä—Ç–∏—Ä—É–π –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
–§–û–†–ú–ê–¢:
–¢–µ—Ä–º–∏–Ω ‚Äî –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ.

–ü—Ä–∏–º–µ—Ä:
–ê–ª–≥–æ—Ä–∏—Ç–º ‚Äî –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏.
"""
        # –í–µ—Å—å –∫–æ–¥ –Ω–∏–∂–µ –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –æ—Ç—Å—Ç—É–ø 4 –ø—Ä–æ–±–µ–ª–∞
        return await self._generate(prompt)

    async def generate_flashcards(self, content: str, num_cards: int = 10) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —Å –ø–æ–ø—ã—Ç–∫–æ–π –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON"""
        prompt = f"""–°–æ–∑–¥–∞–π –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (flashcards).
    –ú–ê–¢–ï–†–ò–ê–õ:
{content[:settings.MAX_CONTENT_LENGTH]}

–ò–ù–°–¢–†–£–ö–¶–ò–ò:

–°–æ–∑–¥–∞–π {num_cards} –∫–∞—Ä—Ç–æ—á–µ–∫
–í–æ–ø—Ä–æ—Å –Ω–∞ –ª–∏—Ü–µ–≤–æ–π —Å—Ç–æ—Ä–æ–Ω–µ, –æ—Ç–≤–µ—Ç –Ω–∞ –æ–±—Ä–∞—Ç–Ω–æ–π
–í–æ–ø—Ä–æ—Å—ã –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–Ω–∏–º–∞–Ω–∏–µ, –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø–∞–º—è—Ç—å
–§–û–†–ú–ê–¢ (—Å—Ç—Ä–æ–≥–æ JSON):

JSON

{{
  "flashcards": [
    {{
      "id": 1,
      "front": "–ß—Ç–æ —Ç–∞–∫–æ–µ X?",
      "back": "X ‚Äî —ç—Ç–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ"
    }}
  ]
}}
–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON.
"""
        # –í–µ—Å—å –∫–æ–¥ –Ω–∏–∂–µ –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –æ—Ç—Å—Ç—É–ø 4 –ø—Ä–æ–±–µ–ª–∞
        response = await self._generate(prompt)
        
        # –ü—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å –∏ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å JSON
        try:
            json_str = response
            if "```json" in json_str:
                json_str = json_str.split("```json", 1)[1].split("```", 1)[0]
            elif "```" in json_str:
                json_str = json_str.split("```", 1)[1].split("```", 1)[0]
            
            parsed = json.loads(json_str.strip())
            return json.dumps(parsed, ensure_ascii=False, indent=2)
        except json.JSONDecodeError:
            print(f"JSON Decode Error in generate_flashcards. Raw response: {response[:200]}...")
            return response

# Singleton instance
gemini_service = GeminiService()